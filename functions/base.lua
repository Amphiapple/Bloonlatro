--Tower info and effects
Joker_effects_vtsg = {
    --Vanilla Jokers
    j_joker=            {effect = {'+mult'}, weight = 1},
    j_greedy_joker=     {effect = {'+mult'}, weight = 1},
    j_lusty_joker=      {effect = {'+mult'}, weight = 1},
    j_wrathful_joker=   {effect = {'+mult'}, weight = 1},
    j_gluttenous_joker= {effect = {'+mult'}, weight = 1},
    j_jolly=            {effect = {'+mult'}, weight = 1},
    j_zany=             {effect = {'+mult'}, weight = 1},
    j_mad=              {effect = {'+mult'}, weight = 1},
    j_crazy=            {effect = {'+mult'}, weight = 1},
    j_droll=            {effect = {'+mult'}, weight = 1},
    j_sly=              {effect = {'+chips'}, weight = 1},
    j_wily=             {effect = {'+chips'}, weight = 1},
    j_clever=           {effect = {'+chips'}, weight = 1},
    j_devious=          {effect = {'+chips'}, weight = 1},
    j_crafty=           {effect = {'+chips'}, weight = 1},

    j_half=             {effect = {'+mult'}, weight = 1},
    j_stencil=          {effect = {'Xmult'}, weight = 1},
    j_four_fingers=     {effect = {'support'}, weight = 1},
    j_mime=             {effect = {'support'}, weight = 1},
    j_credit_card=      {effect = {'econ'}, weight = 1},
    j_ceremonial=       {effect = {'+mult'}, weight = 1},
    j_banner=           {effect = {'+chips'}, weight = 1},
    j_mystic_summit=    {effect = {'+mult'}, weight = 1},
    j_marble=           {effect = {'support'}, weight = 1},
    j_loyalty_card=     {effect = {'Xmult'}, weight = 1},
    j_8_ball=           {effect = {'value'}, weight = 1},
    j_misprint=         {effect = {'+mult'}, weight = 1},
    j_dusk=             {effect = {'support'}, weight = 1},
    j_raised_fist=      {effect = {'+mult'}, weight = 1},
    j_chaos=            {effect = {'econ'}, weight = 1},

    j_fibonacci=        {effect = {'+mult'}, weight = 1},
    j_steel_joker=      {effect = {'Xmult'}, weight = 1},
    j_scary_face=       {effect = {'+chips'}, weight = 1},
    j_abstract=         {effect = {'+mult'}, weight = 1},
    j_delayed_grat=     {effect = {'econ'}, weight = 1},
    j_hack=             {effect = {'support'}, weight = 1},
    j_pareidolia=       {effect = {'support'}, weight = 1},
    j_gros_michel=      {effect = {'+mult'}, weight = 1},
    j_even_steven=      {effect = {'+mult'}, weight = 1},
    j_odd_todd=         {effect = {'+chips'}, weight = 1},
    j_scholar=          {effect = {'+chips', '+mult'}, weight = 0.5},
    j_business=         {effect = {'econ'}, weight = 1},
    j_supernova=        {effect = {'+mult'}, weight = 1},
    j_ride_the_bus=     {effect = {'+mult'}, weight = 1},
    j_space=            {effect = {'value'}, weight = 1},

    j_egg=              {effect = {'econ'}, weight = 1},
    j_burglar=          {effect = {'support'}, weight = 1},
    j_blackboard=       {effect = {'Xmult'}, weight = 1},
    j_runner=           {effect = {'+chips'}, weight = 1},
    j_ice_cream=        {effect = {'+chips'}, weight = 1},
    j_dna=              {effect = {'support'}, weight = 1},
    j_splash=           {effect = {'support'}, weight = 1},
    j_blue_joker=       {effect = {'+chips'}, weight = 1},
    j_sixth_sense=      {effect = {'value'}, weight = 1},
    j_constellation=    {effect = {'Xmult'}, weight = 1},
    j_hiker=            {effect = {'+chips'}, weight = 1},
    j_faceless=         {effect = {'econ'}, weight = 1},
    j_green_joker=      {effect = {'+mult'}, weight = 1},
    j_superposition=    {effect = {'value'}, weight = 1},
    j_todo_list=        {effect = {'econ'}, weight = 1},

    j_cavendish=        {effect = {'Xmult'}, weight = 1},
    j_card_sharp=       {effect = {'Xmult'}, weight = 1},
    j_red_card=         {effect = {'+mult'}, weight = 1},
    j_madness=          {effect = {'Xmult'}, weight = 1},
    j_square=           {effect = {'+chips'}, weight = 1},
    j_seance=           {effect = {'value'}, weight = 1},
    j_riff_raff=        {effect = {'value'}, weight = 1},
    j_vampire=          {effect = {'Xmult'}, weight = 1},
    j_shortcut=         {effect = {'support'}, weight = 1},
    j_hologram=         {effect = {'Xmult'}, weight = 1},
    j_vagabond=         {effect = {'value'}, weight = 1},
    j_baron=            {effect = {'Xmult'}, weight = 1},
    j_cloud_9=          {effect = {'econ'}, weight = 1},
    j_rocket=           {effect = {'econ'}, weight = 1},
    j_obelisk=          {effect = {'Xmult'}, weight = 1},

    j_midas_mask=       {effect = {'econ'}, weight = 1},
    j_luchador=         {effect = {'support'}, weight = 1},
    j_photograph=       {effect = {'Xmult'}, weight = 1},
    j_gift=             {effect = {'econ'}, weight = 1},
    j_turtle_bean=      {effect = {'support'}, weight = 1},
    j_erosion=          {effect = {'+mult'}, weight = 1},
    j_reserved_parking= {effect = {'econ'}, weight = 1},
    j_mail=             {effect = {'econ'}, weight = 1},
    j_to_the_moon=      {effect = {'econ'}, weight = 1},
    j_hallucination=    {effect = {'value'}, weight = 1},
    j_fortune_teller=   {effect = {'+mult'}, weight = 1},
    j_juggler=          {effect = {'support'}, weight = 1},
    j_drunkard=         {effect = {'support'}, weight = 1},
    j_stone=            {effect = {'+chips'}, weight = 1},
    j_golden=           {effect = {'econ'}, weight = 1},

    j_lucky_cat=        {effect = {'Xmult'}, weight = 1},
    j_baseball=         {effect = {'Xmult'}, weight = 1},
    j_bull=             {effect = {'+chips'}, weight = 1},
    j_diet_cola=        {effect = {'value'}, weight = 1},
    j_trading=          {effect = {'econ'}, weight = 1},
    j_flash=            {effect = {'+mult'}, weight = 1},
    j_popcorn=          {effect = {'+mult'}, weight = 1},
    j_trousers=         {effect = {'+mult'}, weight = 1},
    j_ancient=          {effect = {'Xmult'}, weight = 1},
    j_ramen=            {effect = {'Xmult'}, weight = 1},
    j_walkie_talkie=    {effect = {'+chips', '+mult'}, weight = 0.5},
    j_selzer=           {effect = {'support'}, weight = 1},
    j_castle=           {effect = {'+chips'}, weight = 1},
    j_smiley=           {effect = {'+mult'}, weight = 1},
    j_campfire=         {effect = {'Xmult'}, weight = 1},

    j_ticket=           {effect = {'econ'}, weight = 1},
    j_mr_bones=         {effect = {'support'}, weight = 1},
    j_acrobat=          {effect = {'Xmult'}, weight = 1},
    j_sock_and_buskin=  {effect = {'support'}, weight = 1},
    j_swashbuckler=     {effect = {'+mult'}, weight = 1},
    j_troubadour=       {effect = {'support'}, weight = 1},
    j_certificate=      {effect = {'support'}, weight = 1},
    j_smeared=          {effect = {'support'}, weight = 1},
    j_throwback=        {effect = {'Xmult'}, weight = 1},
    j_hanging_chad=     {effect = {'support'}, weight = 1},
    j_rough_gem=        {effect = {'econ'}, weight = 1},
    j_bloodstone=       {effect = {'Xmult'}, weight = 1},
    j_arrowhead=        {effect = {'+chips'}, weight = 1},
    j_onyx_agate=       {effect = {'+mult'}, weight = 1},
    j_glass=            {effect = {'Xmult'}, weight = 1},

    j_ring_master=      {effect = {'support'}, weight = 1},
    j_flower_pot=       {effect = {'Xmult'}, weight = 1},
    j_blueprint=        {effect = {'support'}, weight = 1},
    j_wee=              {effect = {'+chips'}, weight = 1},
    j_merry_andy=       {effect = {'support'}, weight = 1},
    j_oops=             {effect = {'support'}, weight = 1},
    j_idol=             {effect = {'Xmult'}, weight = 1},
    j_seeing_double=    {effect = {'Xmult'}, weight = 1},
    j_matador=          {effect = {'econ'}, weight = 1},
    j_hit_the_road=     {effect = {'Xmult'}, weight = 1},
    j_duo=              {effect = {'Xmult'}, weight = 1},
    j_trio=             {effect = {'Xmult'}, weight = 1},
    j_family=           {effect = {'Xmult'}, weight = 1},
    j_order=            {effect = {'Xmult'}, weight = 1},
    j_tribe=            {effect = {'Xmult'}, weight = 1},

    j_stuntman=         {effect = {'+chips'}, weight = 1},
    j_invisible=        {effect = {'value'}, weight = 1},
    j_brainstorm=       {effect = {'support'}, weight = 1},
    j_satellite=        {effect = {'econ'}, weight = 1},
    j_shoot_the_moon=   {effect = {'+mult'}, weight = 1},
    j_drivers_license=  {effect = {'Xmult'}, weight = 1},
    j_cartomancer=      {effect = {'value'}, weight = 1},
    j_astronomer=       {effect = {'econ'}, weight = 1},
    j_burnt=            {effect = {'value'}, weight = 1},
    j_bootstraps=       {effect = {'+mult'}, weight = 1},
    j_caino=            {effect = {'Xmult'}, weight = 1},
    j_triboulet=        {effect = {'Xmult'}, weight = 1},
    j_yorick=           {effect = {'Xmult'}, weight = 1},
    j_chicot=           {effect = {'support'}, weight = 1},
    j_perkeo=           {effect = {'value'}, weight = 1},

    --Bloonlatro Jokers
    j_bloons_dart=      {effect = {'+chips', '+mult'}, weight = 0.5},
    j_bloons_quick=     {effect = {'+chips', '+mult'}, weight = 0.5},
    j_bloons_eyesight=  {effect = {'support'}, weight = 1},
    j_bloons_tripshot=  {effect = {'value'}, weight = 1},
    j_bloons_jugg=      {effect = {'+mult'}, weight = 1},
    j_bloons_xbm=       {effect = {'Xmult'}, weight = 1},

    j_bloons_boomer=    {effect = {'support'}, weight = 1},
    j_bloons_glaives=   {effect = {'+chips'}, weight = 1},
    j_bloons_redhot=    {effect = {'support'}, weight = 1},
    j_bloons_bioboomer= {effect = {'+chips'}, weight = 1},
    j_bloons_press=     {effect = {'support'}, weight = 1},
    j_bloons_glord=     {effect = {'+chips'}, weight = 1},

    j_bloons_bomb=      {effect = {'Xmult'}, weight = 1},
    j_bloons_missile=   {effect = {'econ'}, weight = 1},
    j_bloons_frags=     {effect = {'value'}, weight = 1},
    j_bloons_mauler=    {effect = {'Xmult'}, weight = 1},
    j_bloons_blimpact=  {effect = {'+mult'}, weight = 1},
    j_bloons_blitz=     {effect = {'support'}, weight = 1},

    j_bloons_tack=      {effect = {'+chips', '+mult'}, weight = 0.5},
    j_bloons_moretacks= {effect = {'+chips', '+mult'}, weight = 0.5},
    j_bloons_evenmore=  {effect = {'+chips', '+mult'}, weight = 0.5},
    j_bloons_blade=     {effect = {'+mult'}, weight = 1},
    j_bloons_od=        {effect = {'Xmult'}, weight = 1},
    j_bloons_iring=     {effect = {'support'}, weight = 1},

    j_bloons_ice=       {effect = {'+chips'}, weight = 1},
    j_bloons_pfrost=    {effect = {'+chips', 'econ'}, weight = 0.5},
    j_bloons_refreeze=  {effect = {'support'}, weight = 1},
    j_bloons_shards=    {effect = {'+mult'}, weight = 1},
    j_bloons_icicles=   {effect = {'Xmult'}, weight = 1},
    j_bloons_az=        {effect = {'value'}, weight = 1},

    j_bloons_glue=      {effect = {'+mult'}, weight = 1},
    j_bloons_corrosive= {effect = {'+chips'}, weight = 1},
    j_bloons_mglue    = {effect = {'Xmult'}, weight = 1},
    j_bloons_glose=     {effect = {'support'}, weight = 1},
    j_bloons_relentless={effect = {'support'}, weight = 1},
    j_bloons_solver=    {effect = {'+mult'}, weight = 1},

    j_bloons_desp=      {effect = {'+chips'}, weight = 1},
    j_bloons_nomad=     {effect = {'+chips'}, weight = 1},
    j_bloons_enforcer=  {effect = {'Xmult'}, weight = 1},
    j_bloons_twix=      {effect = {'Xmult'}, weight = 1},
    j_bloons_gustice=   {effect = {'Xmult', 'econ'}, weight = 0.5},

    j_bloons_sniper=    {effect = {'+mult'}, weight = 1},
    j_bloons_shraps=    {effect = {'+mult'}, weight = 1},
    j_bloons_dprec=     {effect = {'Xmult'}, weight = 1},
    j_bloons_supply=    {effect = {'value'}, weight = 1},
    j_bloons_edef=      {effect = {'Xmult'}, weight = 1},

    j_bloons_sub=       {effect = {'+mult'}, weight = 1},
    j_bloons_intel=     {effect = {'support'}, weight = 1},
    j_bloons_tripguns=  {effect = {'Xmult'}, weight = 1},
    j_bloons_fs=        {effect = {'Xmult'}, weight = 1},
    j_bloons_gizer=     {effect = {'econ'}, weight = 1},

    j_bloons_boat=      {effect = {'econ'}, weight = 1},
    j_bloons_grape=     {effect = {'econ'}, weight = 1},
    j_bloons_destroyer= {effect = {'Xmult'}, weight = 1},
    j_bloons_flavored=  {effect = {'value'}, weight = 1},
    j_bloons_plord=     {effect = {'+mult', 'econ'}, weight = 0.5},

    j_bloons_ace=       {effect = {'+chips'}, weight = 1},
    j_bloons_pineapple= {effect = {'support'}, weight = 1},
    j_bloons_nevamiss=  {effect = {'value'}, weight = 1},
    j_bloons_gz=        {effect = {'+chips'}, weight = 1},
    j_bloons_shredder=  {effect = {'Xmult'}, weight = 1},

    j_bloons_heli=      {effect = {'Xmult'}, weight = 1},
    j_bloons_quad=      {effect = {'+mult'}, weight = 1},
    j_bloons_draft=     {effect = {'support'}, weight = 1},
    j_bloons_comdef=    {effect = {'+chips'}, weight = 1},
    j_bloons_aprime=    {effect = {'Xmult'}, weight = 1},
    j_bloons_spop=      {effect = {'value', 'cash'}, weight = 0.5},

    j_bloons_mortar=    {effect = {'+mult'}, weight = 1},
    j_bloons_burny=     {effect = {'support'}, weight = 1},
    j_bloons_sshock=    {effect = {'+mult'}, weight = 1},
    j_bloons_abatt=     {effect = {'+chips', '+mult', 'Xmult'}, weight = 0.5},
    j_bloons_cin=       {effect = {'Xmult'}, weight = 1},

    j_bloons_dartling=  {effect = {'+chips'}, weight = 1},
    j_bloons_lshock=    {effect = {'+mult'}, weight = 1},
    j_bloons_buckshot=  {effect = {'Xmult'}, weight = 1},
    j_bloons_rorm=      {effect = {'Xmult'}, weight = 1},
    j_bloons_rod=       {effect = {'Xmult'}, weight = 1},

    j_bloons_wiz=       {effect = {'support'}, weight = 1},
    j_bloons_wof=       {effect = {'support'}, weight = 1},
    j_bloons_amast=     {effect = {'value'}, weight = 1},
    j_bloons_necro=     {effect = {'support'}, weight = 1},
    j_bloons_wlp=       {effect = {'value'}, weight = 1},

    j_bloons_super=     {effect = {'Xmult'}, weight = 1},
    j_bloons_laser=     {effect = {'Xmult'}, weight = 1},
    j_bloons_uv=        {effect = {'support'}, weight = 1},
    j_bloons_sav=       {effect = {'Xmult'}, weight = 1},
    j_bloons_tech=      {effect = {'support'}, weight = 1},
    j_bloons_lotn=      {effect = {'value', 'support'}, weight = 0.5},
    
    j_bloons_ninja=     {effect = {'+mult'}, weight = 1},
    j_bloons_espionage= {effect = {'support'}, weight = 1},
    j_bloons_shinobi=   {effect = {'Xmult'}, weight = 1},
    j_bloons_flash=     {effect = {'+mult'}, weight = 1},
    j_bloons_sabo=      {effect = {'support'}, weight = 1},
    j_bloons_gmn=       {effect = {'Xmult'}, weight = 1},

    j_bloons_alch=      {effect = {'value'}, weight = 1},
    j_bloons_amd=       {effect = {'support'}, weight = 1},
    j_bloons_brew=      {effect = {'Xmult'}, weight = 1},
    j_bloons_r2g=       {effect = {'econ'}, weight = 1},
    j_bloons_tt5=       {effect = {'value'}, weight = 1},

    j_bloons_druid=     {effect = {'+mult'}, weight = 1},
    j_bloons_thunder=   {effect = {'value'}, weight = 1},
    j_bloons_dots=      {effect = {'support'}, weight = 1},
    j_bloons_jbounty=   {effect = {'econ'}, weight = 1},
    j_bloons_aow=       {effect = {'Xmult'}, weight = 1},

    j_bloons_merm=      {effect = {'+mult'}, weight = 1},
    j_bloons_network=   {effect = {'value'}, weight = 1},
    j_bloons_melody=    {effect = {'+chips', 'support'}, weight = 0.5},
    j_bloons_arknight=  {effect = {'support'}, weight = 1},
    j_bloons_lota=      {effect = {'+mult'}, weight = 1},

    j_bloons_farm=      {effect = {'econ'}, weight = 1},
    j_bloons_valuable=  {effect = {'econ'}, weight = 1},
    j_bloons_salvage=   {effect = {'econ'}, weight = 1},
    j_bloons_plantation={effect = {'econ'}, weight = 1},
    j_bloons_bank=      {effect = {'econ'}, weight = 1},
    j_bloons_brf=       {effect = {'Xmult'}, weight = 1},
    j_bloons_wallstreet={effect = {'econ'}, weight = 1},

    j_bloons_spac=      {effect = {'+chips'}, weight = 1},
    j_bloons_stacks=    {effect = {'econ'}, weight = 1},
    j_bloons_smart=     {effect = {'+mult'}, weight = 1},
    j_bloons_lls=       {effect = {'+mult'}, weight = 1},
    j_bloons_sporm=     {effect = {'Xmult'}, weight = 1},
    j_bloons_pspike=    {effect = {'support'}, weight = 1},

    j_bloons_village=   {effect = {'+mult'}, weight = 1},
    j_bloons_drums=     {effect = {'Xmult'}, weight = 1},
    j_bloons_discount=  {effect = {'econ'}, weight = 1},
    j_bloons_mib=       {effect = {'support'}, weight = 1},
    j_bloons_city=      {effect = {'value', 'econ'}, weight = 0.5},
    j_bloons_pex=       {effect = {'Xmult', 'econ'}, weight = 0.5},

    j_bloons_engi=      {effect = {'econ'}, weight = 1},
    j_bloons_sentries=  {effect = {'value'}, weight = 1},
    j_bloons_doublegun= {effect = {'econ'}, weight = 1},
    j_bloons_sexpert=   {effect = {'value'}, weight = 1},
    j_bloons_uboost=    {effect = {'Xmult'}, weight = 1},

    j_bloons_beast=     {effect = {'+chips'}, weight = 1},
    j_bloons_owl=       {effect = {'value'}, weight = 1},
    j_bloons_velo=      {effect = {'+mult', 'support'}, weight = 0.5},
    j_bloons_condor=    {effect = {'support'}, weight = 1},
    j_bloons_meg=       {effect = {'+chips', '+mult'}, weight = 0.5},

    j_bloons_marine=    {effect = {'Xmult'}, weight = 1},
    j_bloons_sentry=    {effect = {'+chips', '+mult'}, weight = 0.5},
    j_bloons_crushing_sentry=   {effect = {'+mult'}, weight = 1},
    j_bloons_boom_sentry=       {effect = {'Xmult'}, weight = 1},
    j_bloons_cold_sentry=       {effect = {'support'}, weight = 1},
    j_bloons_energy_sentry=     {effect = {'+chips', '+mult'}, weight = 0.5},
    j_bloons_bloonprint={effect = {'support'}, weight = 1},

    j_bloons_mdom=      {effect = {'Xmult', 'value'}, weight = 0.5},
    j_bloons_fortress=  {effect = {'value', 'econ',}, weight = 0.5},
    j_bloons_pbrew=     {effect = {'support'}, weight = 1},
    j_bloons_smines=    {effect = {'Xmult'}, weight = 1},
    j_bloons_vtsg=      {effect = {'support'}, weight = 1},
}

--Tower effects function
function Card.get_effects_vtsg(self)
    local key = self.config.center_key
    if Joker_effects_vtsg[key] then
        return Joker_effects_vtsg[key].effect
    end
    return {'support'}
end

--Tower effect weight function
function Card.get_effect_weight_vtsg(self)
    local key = self.config.center_key
    if Joker_effects_vtsg[key] then
        return Joker_effects_vtsg[key].weight
    end
    return 1
end

--Challenge id function
function get_challenge_stake(e)
    local key = G.CHALLENGES[e.config.id].id
    if key and Challenge_stakes[key] then
        return Challenge_stakes[key].stake
    end
    return 1
end

--Recalculate cost function
function recalc_all_costs()
    G.E_MANAGER:add_event(Event({
        trigger = 'after',
        delay = 0.0,
        func = (function()
            for k, v in pairs(G.I.CARD) do
                if v.set_cost then
                    v:set_cost()
                end
            end
            return true
        end)
    }))
end

--Mdom new end round
function end_round_new(mdoms)
    G.E_MANAGER:add_event(Event({
        trigger = 'after',
        delay = 0.2,
        func = function()
            local game_over = true
            local game_won = false
            G.RESET_BLIND_STATES = true
            G.RESET_JIGGLES = true
            if G.GAME.chips - G.GAME.blind.chips >= to_big(0) then
                game_over = false
            end
            for i = 1, #G.jokers.cards do
                local eval = nil
                eval = G.jokers.cards[i]:calculate_joker({end_of_round = true, game_over = game_over})
                if eval then
                    if eval.saved then
                        game_over = false
                    end
                    card_eval_status_text(G.jokers.cards[i], 'jokers', nil, nil, nil, eval)
                end
                G.jokers.cards[i]:calculate_rental()
                G.jokers.cards[i]:calculate_perishable()
            end
            if game_over then
                G.STATE = G.STATES.GAME_OVER
                if not G.GAME.won and not G.GAME.seeded and not G.GAME.challenge then 
                    G.PROFILES[G.SETTINGS.profile].high_scores.current_streak.amt = 0
                end
                G:save_settings()
                G.FILE_HANDLER.force = true
                G.STATE_COMPLETE = false
            else
                G.GAME.unused_discards = (G.GAME.unused_discards or 0) + G.GAME.current_round.discards_left
                if G.GAME.blind and G.GAME.blind.config.blind then 
                    discover_card(G.GAME.blind.config.blind)
                end

                if G.GAME.blind:get_type() == 'Boss' and not G.GAME.seeded and not G.GAME.challenge  then
                    G.GAME.current_boss_streak = G.GAME.current_boss_streak + 1
                    check_and_set_high_score('boss_streak', G.GAME.current_boss_streak)
                end
                
                if G.GAME.current_round.hands_played == 1 then 
                    inc_career_stat('c_single_hand_round_streak', 1)
                else
                    if not G.GAME.seeded and not G.GAME.challenge  then
                        G.PROFILES[G.SETTINGS.profile].career_stats.c_single_hand_round_streak = 0
                        G:save_settings()
                    end
                end

                check_for_unlock({type = 'round_win'})
                set_joker_usage()
                for i=1, #G.hand.cards do
                    --Check for hand doubling
                    local reps = {1}
                    local j = 1
                    while j <= #reps do
                        local percent = (i-0.999)/(#G.hand.cards-0.998) + (j-1)*0.1
                        if reps[j] ~= 1 then card_eval_status_text((reps[j].jokers or reps[j].seals).card, 'jokers', nil, nil, nil, (reps[j].jokers or reps[j].seals)) end
    
                        --calculate the hand effects
                        local effects = {G.hand.cards[i]:get_end_of_round_effect()}
                        for k=1, #G.jokers.cards do
                            --calculate the joker individual card effects
                            local eval = G.jokers.cards[k]:calculate_joker({cardarea = G.hand, other_card = G.hand.cards[i], individual = true, end_of_round = true})
                            if eval then 
                                table.insert(effects, eval)
                            end
                        end

                        if reps[j] == 1 then 
                            --Check for hand doubling
                            --From Red seal
                            local eval = eval_card(G.hand.cards[i], {end_of_round = true,cardarea = G.hand, repetition = true, repetition_only = true})
                            if next(eval) and (next(effects[1]) or #effects > 1)  then 
                                for h = 1, eval.seals.repetitions do
                                    reps[#reps+1] = eval
                                end
                            end

                            --from Jokers
                            for j=1, #G.jokers.cards do
                                --calculate the joker effects
                                local eval = eval_card(G.jokers.cards[j], {cardarea = G.hand, other_card = G.hand.cards[i], repetition = true, end_of_round = true, card_effects = effects})
                                if next(eval) then 
                                    for h  = 1, eval.jokers.repetitions do
                                        reps[#reps+1] = eval
                                    end
                                end
                            end
                        end
        
                        for ii = 1, #effects do
                            --if this effect came from a joker
                            if effects[ii].card then
                                G.E_MANAGER:add_event(Event({
                                    trigger = 'immediate',
                                    func = (function() effects[ii].card:juice_up(0.7);return true end)
                                }))
                            end
                            
                            --If dollars
                            if effects[ii].h_dollars then 
                                ease_dollars(effects[ii].h_dollars)
                                card_eval_status_text(G.hand.cards[i], 'dollars', effects[ii].h_dollars, percent)
                            end

                            --Any extras
                            if effects[ii].extra then
                                card_eval_status_text(G.hand.cards[i], 'extra', nil, percent, nil, effects[ii].extra)
                            end
                        end
                        j = j + 1
                    end
                end
                delay(0.3)

                G.FUNCS.draw_from_hand_to_discard()
                G.FUNCS.draw_from_discard_to_deck()
                G.E_MANAGER:add_event(Event({
                    trigger = 'after',
                    delay = 0.3,
                    func = function()
                        G.STATE = G.STATES.ROUND_EVAL
                        G.STATE_COMPLETE = false

                        if G.GAME.round_resets.blind == G.P_BLINDS.bl_small then
                            G.GAME.round_resets.blind_states.Small = 'Defeated'
                        elseif G.GAME.round_resets.blind == G.P_BLINDS.bl_big then
                            G.GAME.round_resets.blind_states.Big = 'Defeated'
                        else
                            for k, v in pairs(mdoms) do
                                v.ability.extra.active = false
                            end
                        end

                        if G.GAME.round_resets.temp_handsize then G.hand:change_size(-G.GAME.round_resets.temp_handsize); G.GAME.round_resets.temp_handsize = nil end
                        if G.GAME.round_resets.temp_reroll_cost then G.GAME.round_resets.temp_reroll_cost = nil; calculate_reroll_cost(true) end

                        reset_idol_card()
                        reset_mail_rank()
                        reset_ancient_card()
                        reset_castle_card()
                        for k, v in ipairs(G.playing_cards) do
                            v.ability.discarded = nil
                            v.ability.forced_selection = nil
                        end
                    return true
                    end
                }))
            end
        return true
        end
    }))
end